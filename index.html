<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§ì…ˆ ëº„ì…ˆ ì²œêµ­, ìš”ì •ë‚˜ë¼!</title>
  <style>
    /* í°íŠ¸ ì„¤ì • */
    @font-face {
      font-family: 'OngleipKonkon';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2412-1@1.0/Ownglyph_corncorn-Rg.woff2') format('woff2');
      font-weight: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'MaplestoryOTFBold';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@2.1/MaplestoryOTFBold.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    
    body {
      font-family: 'OngleipKonkon', sans-serif;
      background: #e0f7fa;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      overflow: hidden;
      user-select: none;
    }
    
    .container {
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 15px;
      max-width: 950px;
      width: 100%;
      height: 95vh;
      position: relative;
      border: 8px solid #00acc1;
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* === ìƒë‹¨ ë²„íŠ¼ ë° íƒ€ì´í‹€ === */
    .top-left-btn { position: absolute; top: 15px; left: 20px; z-index: 20; }
    .top-right-btn { position: absolute; top: 15px; right: 20px; z-index: 20; }

    .header-btn {
        background: #26c6da; color: #fff; border: none; padding: 8px 15px;
        border-radius: 10px; font-size: 1.1em; cursor: pointer; border-bottom: 3px solid #0097a7;
        font-family: 'OngleipKonkon'; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-btn:hover { background: #00bcd4; transform: translateY(2px); border-bottom-width: 1px; }

    h1 {
      font-family: 'MaplestoryOTFBold', sans-serif;
      color: #00838f;
      margin: 10px 0 10px 0;
      font-size: 2.0em;
      text-align: center;
      text-shadow: 2px 2px 0px #b2ebf2;
      display: flex; align-items: center; gap: 15px; justify-content: center;
      width: 100%; pointer-events: none;
    }
    .title-icon { height: 1.5em; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); }

    /* === ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ === */
    .btn {
      background: #ff7043; color: #fff; border: none; padding: 10px 25px;
      border-radius: 15px; font-size: 1.5em; cursor: pointer;
      border-bottom: 5px solid #d84315; transition: 0.2s;
      font-family: 'OngleipKonkon', sans-serif;
    }
    .btn:active { transform: translateY(3px); border-bottom-width: 2px; }
    .btn:hover { filter: brightness(1.1); }
    .btn-green { background: #66bb6a; border-bottom-color: #388e3c; }
    .btn-blue { background: #42a5f5; border-bottom-color: #1976d2; }
    .btn-home { background: #5d4037; border-bottom-color: #3e2723; }
    .btn-gray { background: #90a4ae; border-bottom-color: #546e7a; }

    .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
    .screen.active { display: flex; }

    /* === ì¸íŠ¸ë¡œ (ë™í™”ì±…) === */
    #intro-screen { justify-content: center; }
    .story-book {
      width: 90%; height: 80%; background: #fff;
      border: 4px solid #8d6e63; border-radius: 15px; padding: 30px;
      box-shadow: 10px 10px 20px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; align-items: center; position: relative;
      background-image: linear-gradient(to right, #fafafa 0%, #fff 5%, #fff 95%, #eee 100%);
    }
    .book-spine { position: absolute; left: 15px; top: 0; bottom: 0; width: 5px; background: #eee; border-right: 1px solid #ccc; }
    
    .story-page { 
        display: none; width: 100%; height: 100%; animation: fadeIn 0.5s; 
        flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
        align-items: center; gap: 30px;
    }
    .story-page.active { display: flex; }
    
    .story-img-area {
      flex: 1.2; height: 90%; background: #fff; border-radius: 15px; border: 3px solid #8d6e63;
      display: flex; justify-content: center; align-items: center; overflow: hidden;
      box-shadow: 5px 5px 10px rgba(0,0,0,0.1);
    }
    .story-img { width: 100%; height: 100%; object-fit: cover; }
    
    .story-content { flex: 1; height: 90%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .story-text {
      font-size: 1.35em; line-height: 1.5; color: #37474f; 
      text-align: left; word-break: keep-all; margin-bottom: 20px;
      background: rgba(255,255,255,0.6); padding: 20px; border-radius: 10px;
      border: 2px dashed #b0bec5; width: 100%; max-height: 70%; overflow-y: auto;
    }
    .story-nav { display: flex; gap: 15px; width: 100%; justify-content: center; }

    @keyframes fadeIn { from { opacity:0; transform: translateX(10px); } to { opacity:1; transform: translateX(0); } }

    /* === ë¡œê·¸ì¸ & ë¡œë¹„ === */
    .login-container { display: flex; flex-direction: column; width: 100%; height: 100%; position: relative; }
    
    .login-grid {
      display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
      gap: 15px; width: 100%; flex: 1; margin-bottom: 10px; z-index: 2;
    }
    .player-setup-box {
      background: rgba(255,255,255,0.95); border: 3px solid #b0bec5; border-radius: 15px;
      padding: 10px 15px; display: flex; flex-direction: column; gap: 8px; position: relative;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .player-label { font-weight: bold; color: #00838f; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
    .setup-row { display: flex; gap: 5px; }
    .styled-select {
        flex: 1; padding: 5px; font-size: 1.0em; border: 2px solid #81d4fa; border-radius: 8px;
        font-family: 'OngleipKonkon'; cursor: pointer;
    }
    .char-preview-btn {
        width: 100%; padding: 8px; background: #e0f7fa; border: 2px dashed #00acc1; border-radius: 8px;
        color: #006064; cursor: pointer; font-size: 1.0em; display: flex; align-items: center; justify-content: center; gap: 10px; flex: 1;
    }
    .char-preview-btn:hover { background: #b2ebf2; }
    .char-thumb-small { width: 35px; height: 35px; object-fit: contain; }

    /* ë¡œë¹„ ìºë¦­í„° í™•ëŒ€ */
    .lobby-footer {
        height: 250px; width: 100%; display: flex; align-items: flex-end; justify-content: center;
        position: relative; margin-top: -30px;
    }
    .lobby-char-left, .lobby-char-right {
        position: absolute; bottom: 10px; display: flex; gap: 20px; pointer-events: none; z-index: 1;
    }
    .lobby-char-left { left: 10px; }
    .lobby-char-right { right: 10px; }
    
    .lobby-char-img { 
        height: 230px; width: auto; filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.2)); transition: transform 0.3s;
    }
    .lobby-char-img:hover { transform: scale(1.1) translateY(-10px); }
    
    .start-btn-area { z-index: 10; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; }

    /* === ê²Œì„ í™”ë©´ === */
    #game-screen { position: relative; justify-content: center; }
    
    .player-box {
        position: absolute; background: #fff; padding: 10px; border-radius: 15px; border: 4px solid #cfd8dc;
        width: 220px; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between;
        z-index: 5; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: 0.3s;
    }
    .player-box.active {
        border-color: #ff7043; background: #fff3e0; transform: scale(1.05); z-index: 10;
        box-shadow: 0 0 25px rgba(255, 112, 67, 0.5);
    }
    .player-box.timeout { filter: grayscale(1); opacity: 0.6; }
    
    #p1-box { top: 0; left: 0; }
    #p2-box { bottom: 0; left: 0; }
    #p3-box { bottom: 0; right: 0; }
    #p4-box { top: 0; right: 0; }
    #p3-box .p-char-img img, #p4-box .p-char-img img { transform: scaleX(-1); }

    .p-info { display: flex; justify-content: space-between; font-size: 1.0em; color: #546e7a; margin-bottom: 5px; }
    .p-name { font-size: 1.2em; font-weight: bold; color: #37474f; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 140px;}
    
    /* ê²Œì„ ë‚´ ìºë¦­í„° í™•ëŒ€ */
    .p-char-img { 
        width: 150px; height: 140px; 
        align-self: center; display: flex; justify-content: center; align-items: center; margin: 5px 0; 
    }
    .p-char-img img { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); }

    .problem-area {
        background: #fff; padding: 25px; border-radius: 30px; border: 5px solid #00acc1; width: 480px;
        display: flex; flex-direction: column; align-items: center; box-shadow: 0 15px 30px rgba(0,0,0,0.15); z-index: 2;
    }
    .problem-text { font-size: 3.5em; font-weight: bold; color: #006064; margin: 10px 0; font-family: 'MaplestoryOTFBold'; }
    
    #answerInput {
        width: 150px; height: 60px; font-size: 2.4em; text-align: center;
        border: 4px solid #ff7043; border-radius: 15px; background: #fff8e1; outline: none; color: #333; font-family: 'MaplestoryOTFBold';
    }
    /* ì¿¨íƒ€ì„ ì¤‘ì¼ ë•Œ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    #answerInput.disabled { background: #e0e0e0; border-color: #9e9e9e; color: #757575; }

    .feedback { height: 35px; font-size: 1.3em; font-weight: bold; margin: 8px; white-space: nowrap; }

    /* í‚¤íŒ¨ë“œ í™•ëŒ€ */
    .numpad { 
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; 
        margin-top: 15px; width: 100%; max-width: 380px; 
    }
    .num-btn {
        background: #f5f5f5; border: 3px solid #cfd8dc; border-radius: 15px; 
        font-size: 2.0em; padding: 15px 0; 
        cursor: pointer; color: #455a64; font-family: 'MaplestoryOTFBold'; transition: 0.1s;
        touch-action: manipulation;
    }
    .num-btn.submit { background: #ff7043; color: white; border-color: #d84315; }
    .num-btn.clear { background: #ffcc80; border-color: #ffa726; }
    .num-btn:active { background: #cfd8dc; transform: scale(0.95); }
    /* ì¿¨íƒ€ì„ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .num-btn.disabled { opacity: 0.5; pointer-events: none; }

    #turn-indicator {
        position: absolute; width: 60px; height: 60px; top: 50%; left: 50%;
        transform: translate(-50%, -50%); z-index: 20; pointer-events: none; transition: top 0.5s, left 0.5s;
    }
    #turn-indicator img { width: 100%; filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.3)); animation: float 1s infinite alternate; }
    @keyframes float { from { transform: translateY(0); } to { transform: translateY(-8px); } }

    /* === ê²°ê³¼ í™”ë©´ === */
    #result-screen { justify-content: flex-start; padding-top: 20px; }
    .chart-container {
        width: 90%; height: 350px; background: #fff; border: 3px solid #b0bec5; border-radius: 15px;
        margin: 20px 0; padding: 20px 40px; display: flex; align-items: flex-end; justify-content: space-around; position: relative;
    }
    .chart-bar-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; width: 15%; position: relative; }
    .bar {
        width: 100%; background: #e0e0e0; border-radius: 10px 10px 0 0;
        transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; display: flex; justify-content: center;
    }
    .bar.class-1 { background: #ef5350; }
    .bar.class-2 { background: #ffa726; }
    .bar.class-3 { background: #66bb6a; }
    .bar.class-4 { background: #42a5f5; }
    
    .score-label { position: absolute; top: -30px; font-weight: bold; font-size: 1.2em; color: #37474f; }
    .class-label { margin-top: 10px; font-weight: bold; font-size: 1.3em; color: #546e7a; }
    
    .my-contribution {
        position: absolute; width: 100%; bottom: 0; left: 0; background: rgba(255,255,255,0.5);
        border-top: 2px dashed rgba(255,255,255,0.8); animation: pulse 2s infinite;
    }

    /* === ëª¨ë‹¬ === */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100; }
    .modal-content { background: #e0f7fa; padding: 20px; border-radius: 15px; width: 650px; border: 5px solid #006064; text-align: center; max-height: 90vh; overflow-y: auto;}
    
    .char-grid { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
    .char-card {
        background: #fff; border: 3px solid #b0bec5; border-radius: 15px; padding: 15px; width: 180px;
        cursor: pointer; transition: 0.2s;
    }
    .char-card:hover { transform: scale(1.05); border-color: #ff7043; background: #fff3e0; }
    .char-card img { width: 140px; height: 140px; object-fit: contain; }
    .char-name { display: block; margin-top: 10px; font-weight: bold; color: #37474f; font-size: 1.3em; }

    .char-detail-view { display: none; flex-direction: column; align-items: center; }
    .char-detail-row { display: flex; gap: 20px; text-align: left; align-items: flex-start; margin: 20px 0; width: 100%;}
    .char-detail-img { width: 220px; height: 240px; object-fit: contain; background: #fff; border-radius: 15px; border: 3px solid #b0bec5; }
    .char-desc-box { flex: 1; background: #fff; padding: 20px; border-radius: 10px; border: 2px solid #81d4fa; font-size: 1.3em; line-height: 1.6; color: #37474f; }
    
    .hof-table { width:100%; border-collapse:collapse; margin-top:10px; background: white; }
    .hof-table th { border-bottom:2px solid #006064; padding:10px; color:#006064; background:#b2ebf2;}
    .hof-table td { border-bottom:1px solid #ddd; padding:10px; }

    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 0.8; } 100% { opacity: 0.5; } }
  </style>
</head>
<body>

<div class="container">
    <div class="top-left-btn">
        <button class="header-btn" onclick="openHelpModal()">ğŸ“– ê²Œì„ ì„¤ëª…</button>
    </div>
    <div class="top-right-btn">
        <button class="header-btn" onclick="openHofModal()">ğŸ”® ì›ƒìŒ êµ¬ìŠ¬ ì°½ê³ </button>
    </div>

    <h1>
        <img src="https://i.imgur.com/NzaVyBQ.png" class="title-icon" alt="ì˜í¬">
        ë§ì…ˆ ëº„ì…ˆ ì²œêµ­, ìš”ì •ë‚˜ë¼!
        <img src="https://i.imgur.com/NzaVyBQ.png" class="title-icon" style="transform:scaleX(-1)" alt="ì˜í¬">
    </h1>

    <!-- 1. ì¸íŠ¸ë¡œ -->
    <div id="intro-screen" class="screen active">
        <div class="story-book">
            <div class="book-spine"></div>
            
            <div class="story-page active" id="page-1">
                <div class="story-img-area">
                    <img src="https://i.imgur.com/DF1BEaQ.jpeg" class="story-img" alt="ì‚½í™”1">
                </div>
                <div class="story-content">
                    <div class="story-text">
                        í•™êµë¥¼ ë§ˆì¹˜ê³  ì§‘ì— ê°€ë˜ <b>ì˜í¬</b>ëŠ”<br>
                        ì‹ ê¸°í•œ ê³¨ëª©ê¸¸ì—ì„œ ë°˜ì§ì´ëŠ” êµ¬ìŠ¬ì„ ì£¼ìš°ë ¤ë‹¤<br>
                        ê°‘ìê¸° ìƒê¸´ <b>êµ¬ë© ì†ìœ¼ë¡œ ì‘¥~</b> ë–¨ì–´ì¡Œì–´ìš”.
                    </div>
                    <div class="story-nav">
                        <button class="btn btn-green" onclick="nextPage(2)">ë‹¤ìŒì¥ &gt;</button>
                    </div>
                </div>
            </div>

            <div class="story-page" id="page-2">
                <div class="story-img-area">
                    <img src="https://i.imgur.com/AgtL0Xy.jpeg" class="story-img" alt="ì‚½í™”2">
                </div>
                <div class="story-content">
                    <div class="story-text">
                        ëˆˆì„ ë– ë³´ë‹ˆ... ìš°ì™€!<br>
                        ê³¼ì¼ê³¼ ìˆ«ìê°€ ë‘¥ë‘¥ ë– ë‹¤ë‹ˆëŠ” <b>ìš”ì •ë‚˜ë¼</b>ì˜€ì–´ìš”!<br><br>
                        <b>"ì•ˆë…•? ìš°ë¦° ë§ì…ˆ ëº„ì…ˆ ìš”ì •ì´ì•¼!"</b><br>
                        ìƒí¼í•œ <b>ë¦¬ì˜¤ë„¬</b>ê³¼ ìƒˆì½¤í•œ <b>ë ˆëª¨</b>ê°€ ë‹¤ê°€ì™”ì–´ìš”.
                    </div>
                    <div class="story-nav">
                        <button class="btn btn-blue" onclick="nextPage(1)">&lt; ì´ì „ì¥</button>
                        <button class="btn btn-green" onclick="nextPage(3)">ë‹¤ìŒì¥ &gt;</button>
                    </div>
                </div>
            </div>

            <div class="story-page" id="page-3">
                <div class="story-img-area">
                    <img src="https://i.imgur.com/60PHbJK.jpeg" class="story-img" alt="ì‚½í™”3">
                </div>
                <div class="story-content">
                    <div class="story-text">
                        <b>"ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê³  ì‹¶ë‹ˆ? ê·¸ëŸ¼ 'ì›ƒìŒ êµ¬ìŠ¬'ì´ í•„ìš”í•´!"</b><br><br>
                        ìš”ì •ë“¤ì€ ìˆ˜í•™ ë¬¸ì œë¥¼ í’€ë©´ ê¸°ë¶„ì´ ì¢‹ì•„ì ¸ì„œ<br>
                        <b>'ì›ƒìŒ êµ¬ìŠ¬'</b>ì„ ì„ ë¬¼ë¡œ ì¤€ëŒ€ìš”.<br>
                        ì˜í¬ê°€ ë¬´ì‚¬íˆ ì§‘ìœ¼ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ì„¸ìš”!<br>
                        <b>ì, ìš”ì •ë‚˜ë¼ë¡œ ì¶œë°œ!</b>
                    </div>
                    <div class="story-nav">
                        <button class="btn btn-blue" onclick="nextPage(2)">&lt; ì´ì „ì¥</button>
                        <button class="btn" onclick="goToLogin()">ë‹¤ ì½ì—ˆì–´ìš”! (ì‹œì‘)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ë¡œê·¸ì¸ -->
    <div id="setup-screen" class="screen">
        <div style="width:100%; text-align:center; margin-bottom:5px; color:#00838f;">
            ì¹œêµ¬ë“¤ì˜ <b>ë°˜</b>ê³¼ <b>ì´ë¦„</b>ì„ ì„ íƒí•˜ê³  <b>íŒŒíŠ¸ë„ˆ</b>ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!
        </div>
        
        <div class="login-container">
            <div class="login-grid">
                <!-- 1P -->
                <div class="player-setup-box">
                    <div class="player-label">1P (ì™¼ìª½ ìœ„)</div>
                    <div class="setup-row">
                        <select id="p1-class" class="styled-select" onchange="updateNameList(1)"><option value="">ë°˜</option></select>
                        <select id="p1-name" class="styled-select"><option value="">ì´ë¦„</option></select>
                    </div>
                    <div class="char-preview-btn" onclick="openCharModal(1)">
                        <span id="p1-char-name">íŒŒíŠ¸ë„ˆ ì„ íƒí•˜ê¸°</span>
                        <input type="hidden" id="p1-char-val" value="char_hero">
                    </div>
                </div>
                <!-- 4P -->
                <div class="player-setup-box">
                    <div class="player-label">4P (ì˜¤ë¥¸ìª½ ìœ„)</div>
                    <div class="setup-row">
                        <select id="p4-class" class="styled-select" onchange="updateNameList(4)"><option value="">ë°˜</option></select>
                        <select id="p4-name" class="styled-select"><option value="">ì´ë¦„</option></select>
                    </div>
                    <div class="char-preview-btn" onclick="openCharModal(4)">
                        <span id="p4-char-name">íŒŒíŠ¸ë„ˆ ì„ íƒí•˜ê¸°</span>
                        <input type="hidden" id="p4-char-val" value="char_sub">
                    </div>
                </div>
                <!-- 2P -->
                <div class="player-setup-box">
                    <div class="player-label">2P (ì™¼ìª½ ì•„ë˜)</div>
                    <div class="setup-row">
                        <select id="p2-class" class="styled-select" onchange="updateNameList(2)"><option value="">ë°˜</option></select>
                        <select id="p2-name" class="styled-select"><option value="">ì´ë¦„</option></select>
                    </div>
                    <div class="char-preview-btn" onclick="openCharModal(2)">
                        <span id="p2-char-name">íŒŒíŠ¸ë„ˆ ì„ íƒí•˜ê¸°</span>
                        <input type="hidden" id="p2-char-val" value="char_add">
                    </div>
                </div>
                <!-- 3P -->
                <div class="player-setup-box">
                    <div class="player-label">3P (ì˜¤ë¥¸ìª½ ì•„ë˜)</div>
                    <div class="setup-row">
                        <select id="p3-class" class="styled-select" onchange="updateNameList(3)"><option value="">ë°˜</option></select>
                        <select id="p3-name" class="styled-select"><option value="">ì´ë¦„</option></select>
                    </div>
                    <div class="char-preview-btn" onclick="openCharModal(3)">
                        <span id="p3-char-name">íŒŒíŠ¸ë„ˆ ì„ íƒí•˜ê¸°</span>
                        <input type="hidden" id="p3-char-val" value="char_hero">
                    </div>
                </div>
            </div>

            <div class="lobby-footer">
                <div class="lobby-char-left">
                    <img src="https://i.imgur.com/EfRD12x.png" class="lobby-char-img" alt="ì˜í¬">
                </div>
                
                <div class="start-btn-area">
                    <div id="login-msg" style="color:#d84315; font-weight:bold; height:20px; margin-bottom:5px;"></div>
                    <button class="btn" onclick="startGame()">ëª¨í—˜ ì‹œì‘!</button>
                </div>

                <div class="lobby-char-right">
                    <img src="https://i.imgur.com/Sn0UfYs.png" class="lobby-char-img" alt="ë¦¬ì˜¤ë„¬">
                    <img src="https://i.imgur.com/XwJLal1.png" class="lobby-char-img" alt="ë ˆëª¨">
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ê²Œì„ í™”ë©´ -->
    <div id="game-screen" class="screen">
        <div id="p1-box" class="player-box"></div>
        <div id="p2-box" class="player-box"></div>
        <div id="p3-box" class="player-box"></div>
        <div id="p4-box" class="player-box"></div>

        <div id="turn-indicator"><img src="https://i.imgur.com/hoFn8n7.png" alt="turn"></div>

        <div class="problem-area">
            <div class="problem-text" id="problemDisplay">? + ? = ?</div>
            <div id="feedback" class="feedback"></div>
            <input type="number" id="answerInput" readonly placeholder="?">
            <div class="numpad">
                <button class="num-btn" onclick="pressKey(7)">7</button>
                <button class="num-btn" onclick="pressKey(8)">8</button>
                <button class="num-btn" onclick="pressKey(9)">9</button>
                <button class="num-btn" onclick="pressKey(4)">4</button>
                <button class="num-btn" onclick="pressKey(5)">5</button>
                <button class="num-btn" onclick="pressKey(6)">6</button>
                <button class="num-btn" onclick="pressKey(1)">1</button>
                <button class="num-btn" onclick="pressKey(2)">2</button>
                <button class="num-btn" onclick="pressKey(3)">3</button>
                <button class="num-btn clear" onclick="pressKey('C')">ì§€ì›€</button>
                <button class="num-btn" onclick="pressKey(0)">0</button>
                <button class="num-btn submit" onclick="checkAnswer()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- 4. ê²°ê³¼ í™”ë©´ -->
    <div id="result-screen" class="screen">
        <h2 style="color:#00838f; font-size:2em; margin-bottom:10px;">ğŸ“Š ìš°ë¦¬ ë°˜ ì›ƒìŒ êµ¬ìŠ¬ í˜„í™©</h2>
        <div style="color:#546e7a; margin-bottom:20px;">ì¹œêµ¬ë“¤ì´ ëª¨ì€ ì›ƒìŒ êµ¬ìŠ¬ì´ ë°˜ë³„ë¡œ ëª¨ì´ê³  ìˆì–´ìš”!</div>
        
        <div class="chart-container" id="chart-area"></div>

        <div style="display:flex; gap:15px;">
            <button class="btn btn-home" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
            <button class="btn" onclick="restartGame()">ë‹¤ì‹œ ë„ì „!</button>
        </div>
    </div>
</div>

<!-- ìºë¦­í„° ì„ íƒ ëª¨ë‹¬ -->
<div id="charModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitle">í•¨ê»˜í•  íŒŒíŠ¸ë„ˆë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!</h2>
        <div id="charGrid" class="char-grid">
            <div class="char-card" onclick="showCharDetail('char_hero')">
                <img src="https://i.imgur.com/NzaVyBQ.png" alt="ì˜í¬">
                <span class="char-name">ì˜í¬</span>
            </div>
            <div class="char-card" onclick="showCharDetail('char_add')">
                <img src="https://i.imgur.com/R5SHQUr.png" alt="ë¦¬ì˜¤ë„¬">
                <span class="char-name">ë¦¬ì˜¤ë„¬</span>
            </div>
            <div class="char-card" onclick="showCharDetail('char_sub')">
                <img src="https://i.imgur.com/LgTx6M2.png" alt="ë ˆëª¨">
                <span class="char-name">ë ˆëª¨</span>
            </div>
        </div>
        <div id="charDetail" class="char-detail-view">
            <div class="char-detail-row">
                <img id="detailImg" src="" class="char-detail-img">
                <div id="detailDesc" class="char-desc-box"></div>
            </div>
            <div style="display:flex; gap:15px;">
                <button class="btn btn-gray" onclick="showCharGrid()">ë’¤ë¡œ ê°€ê¸°</button>
                <button class="btn btn-green" onclick="confirmChar()">ì´ ì¹œêµ¬ë‘ í•˜ê¸°!</button>
            </div>
        </div>
        <button id="modalCloseBtn" class="btn btn-blue" style="margin-top:20px;" onclick="closeCharModal()">ë‹«ê¸°</button>
    </div>
</div>

<!-- ë„ì›€ë§/ì°½ê³  ëª¨ë‹¬ -->
<div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <h2>ğŸ“– ê²Œì„ ì„¤ëª…</h2>
        <div style="text-align:left; padding:10px 20px; font-size:1.3em; line-height:1.7; color:#37474f;">
            <p>1. ë‚´ ì°¨ë¡€ê°€ ë˜ë©´ <b>ë§ì…ˆ</b>ê³¼ <b>ëº„ì…ˆ</b> ë¬¸ì œë¥¼ í’€ì–´ì£¼ì„¸ìš”.</p>
            <p>2. ì •ë‹µì„ ë§íˆë©´ <b>'ì›ƒìŒ êµ¬ìŠ¬'</b>ì„ 10ê°œ ë°›ì•„ìš”.</p>
            <p>3. <b>5ì´ˆ ì•ˆì—</b> ë¹¨ë¦¬ í’€ë©´ êµ¬ìŠ¬ 5ê°œë¥¼ ë” ë°›ì•„ìš”!</p>
            <p>4. <b>ê³„ì† ì •ë‹µ</b>ì„ ë§íˆë©´ ì¹œêµ¬ë“¤ì´ ê¸°ë»ì„œ êµ¬ìŠ¬ì„ ë” ì¤˜ìš”.</p>
            <p>5. ë¬¸ì œë¥¼ í’€ì–´ ëª¨ì€ êµ¬ìŠ¬ì€ <b>ìš°ë¦¬ ë°˜ ì ìˆ˜</b>ì— ë”í•´ì ¸ìš”.</p>
            <p style="text-align:center; color:#e91e63; font-weight:bold; margin-top:15px;">ì¹œêµ¬ë“¤ê³¼ í˜ì„ í•©ì³ ì›ƒìŒ êµ¬ìŠ¬ì„ ê°€ë“ ì±„ì›Œë³´ì„¸ìš”!</p>
        </div>
        <button class="btn btn-blue" style="margin-top:20px;" onclick="closeHelpModal()">ë‹«ê¸°</button>
    </div>
</div>

<div id="hofModal" class="modal-overlay">
    <div class="modal-content">
        <h2>ğŸ”® ë°˜ì§ë°˜ì§ ì›ƒìŒ êµ¬ìŠ¬ ì°½ê³ </h2>
        <div style="margin-bottom:10px; color:#00838f;">ì§€ê¸ˆê¹Œì§€ ì¹œêµ¬ë“¤ì´ ëª¨ì€ êµ¬ìŠ¬ ì ìˆ˜ì˜ˆìš”!</div>
        <div id="hofContent">Loading...</div>
        <button class="btn btn-blue" style="margin-top:20px;" onclick="closeHofModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    // ì„ ìƒë‹˜ì˜ Apps Script URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx--fo_y3yOHGWwcSwqI1_gVxWfMwYgoZpvoq9axbhOPXslMEAhxmZicvxxCfgd5SYC/exec";

    let CLASS_DATA = {};

    // ì—…ë°ì´íŠ¸ëœ ì´ë¯¸ì§€ URL ì ìš©
    const CHAR_IMGS = {
        'char_hero': { 
            name: "ì˜í¬",
            desc: "1970ë…„ëŒ€ì—ì„œ ì˜¨ ì”©ì”©í•œ ë°˜ì¥! ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸° ìœ„í•´ êµ¬ìŠ¬ì„ ëª¨ìœ¼ê³  ìˆì–´. ë¬´ìŠ¨ ì¼ì´ë“  í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë©‹ì§„ ì¹œêµ¬ì•¼!",
            default: 'https://i.imgur.com/NzaVyBQ.png', 
            correct: 'https://i.imgur.com/c0EjrhG.png', 
            wrong: 'https://i.imgur.com/QYQM7pP.png', 
            win: 'https://i.imgur.com/RX8ejSt.png', 
            lose: 'https://i.imgur.com/YFWbXTl.png',
            lobby: 'https://i.imgur.com/EfRD12x.png'
        },
        'char_add': { 
            name: "ë¦¬ì˜¤ë„¬",
            desc: "ìƒí¼í•œ ë¼ì„ ìš”ì • ë¦¬ì˜¤ë„¬! ìˆ«ìê°€ ëŠ˜ì–´ë‚˜ëŠ” ë§ì…ˆì„ ì œì¼ ì¢‹ì•„í•´. ë”í•˜ê¸° ë¬¸ì œë¥¼ í’€ë©´ ê¸°ë¶„ì´ ì¢‹ì•„ì„œ ì¶¤ì„ ì¶˜ëŒ€!",
            default: 'https://i.imgur.com/R5SHQUr.png', 
            correct: 'https://i.imgur.com/h54D1ZO.png', 
            wrong: 'https://i.imgur.com/5KO87ha.png', 
            win: 'https://i.imgur.com/AhozXb5.png', 
            lose: 'https://i.imgur.com/Lg7egAL.png',
            lobby: 'https://i.imgur.com/Sn0UfYs.png'
        },
        'char_sub': { 
            name: "ë ˆëª¨",
            desc: "ìƒˆì½¤í•œ ë ˆëª¬ ìš”ì • ë ˆëª¨! ìˆ«ìë¥¼ ëœì–´ë‚´ëŠ” ëº„ì…ˆì„ ì¢‹ì•„í•´. ë³µì¡í•œ ê±¸ ì‹«ì–´í•´ì„œ ëº„ì…ˆ ë¬¸ì œë¥¼ í’€ë©´ ì‹œì›í•˜ê²Œ ì›ƒì–´ì¤˜!",
            default: 'https://i.imgur.com/LgTx6M2.png', 
            correct: 'https://i.imgur.com/T4Y1jal.png', 
            wrong: 'https://i.imgur.com/82grpdm.png', 
            win: 'https://i.imgur.com/YUIqSVB.png', 
            lose: 'https://i.imgur.com/9jdZaTG.png',
            lobby: 'https://i.imgur.com/XwJLal1.png'
        }
    };

    let players = [];
    let currentPlayerIndex = 0;
    const TOTAL_TIME = 120;
    let timerInterval;
    let currentProblem = {};
    let problemStartTime = 0;
    let targetPlayerIdForChar = 1;
    let tempSelectedCharKey = '';
    
    // ì¿¨íƒ€ì„ ë³€ìˆ˜
    let isProcessing = false;

    window.onload = async function() {
        await loadClassData();
    };

    // ì„œë²„ ëª…ë‹¨ ë¡œë“œ (ì‹¤íŒ¨ ì‹œ ë”ë¯¸ ë°ì´í„° ì‚¬ìš© ì•ˆí•¨ - ì„ ìƒë‹˜ ìš”ì²­ëŒ€ë¡œ)
    async function loadClassData() {
        try {
            const res = await fetch(SCRIPT_URL + "?action=getNames");
            const json = await res.json();
            CLASS_DATA = json;
            for(let i=1; i<=4; i++) {
                initClassDropdown(i);
            }
        } catch(e) {
            console.error("ëª…ë‹¨ ë¡œë“œ ì‹¤íŒ¨", e);
            document.getElementById('login-msg').textContent = "ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì¸í„°ë„· ì—°ê²°ì´ë‚˜ ë°°í¬ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
        }
    }

    function initClassDropdown(pid) {
        const classSelect = document.getElementById(`p${pid}-class`);
        classSelect.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';
        Object.keys(CLASS_DATA).sort().forEach(cls => {
            const opt = document.createElement('option');
            opt.value = cls;
            opt.textContent = `${cls}ë°˜`;
            classSelect.appendChild(opt);
        });
    }

    function updateNameList(pid) {
        const classVal = document.getElementById(`p${pid}-class`).value;
        const nameSelect = document.getElementById(`p${pid}-name`);
        nameSelect.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>';
        if (classVal && CLASS_DATA[classVal]) {
            CLASS_DATA[classVal].forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                nameSelect.appendChild(opt);
            });
        }
    }

    function nextPage(pageNum) {
        document.querySelectorAll('.story-page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageNum}`).classList.add('active');
    }
    function goToLogin() {
        document.getElementById('intro-screen').classList.remove('active');
        document.getElementById('setup-screen').classList.add('active');
    }

    function openCharModal(pid) { targetPlayerIdForChar = pid; showCharGrid(); document.getElementById('charModal').style.display = 'flex'; }
    function closeCharModal() { document.getElementById('charModal').style.display = 'none'; }
    function openHelpModal() { document.getElementById('helpModal').style.display = 'flex'; }
    function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }
    
    async function openHofModal() {
        document.getElementById('hofModal').style.display = 'flex';
        const content = document.getElementById('hofContent');
        content.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        try {
            const res = await fetch(SCRIPT_URL + "?action=getRank");
            const data = await res.json();
            let html = '<table class="hof-table"><thead><tr><th>ë°˜</th><th>ì´ íšë“ êµ¬ìŠ¬</th></tr></thead><tbody>';
            Object.keys(data).sort().forEach(cls => {
                html += `<tr><td>${cls}ë°˜</td><td style="color:#d84315; font-weight:bold;">${data[cls]}ê°œ</td></tr>`;
            });
            html += '</tbody></table>';
            content.innerHTML = html;
        } catch(e) {
            content.innerHTML = 'ì ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.';
        }
    }
    function closeHofModal() { document.getElementById('hofModal').style.display = 'none'; }

    function showCharGrid() {
        document.getElementById('modalTitle').textContent = "í•¨ê»˜í•  íŒŒíŠ¸ë„ˆë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!";
        document.getElementById('charGrid').style.display = 'flex';
        document.getElementById('charDetail').style.display = 'none';
        document.getElementById('modalCloseBtn').style.display = 'inline-block';
    }
    function showCharDetail(charKey) {
        tempSelectedCharKey = charKey;
        const data = CHAR_IMGS[charKey];
        document.getElementById('modalTitle').textContent = "ì´ ì¹œêµ¬ëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?";
        document.getElementById('charGrid').style.display = 'none';
        document.getElementById('charDetail').style.display = 'flex';
        document.getElementById('modalCloseBtn').style.display = 'none';
        document.getElementById('detailImg').src = data.default;
        document.getElementById('detailDesc').textContent = data.desc;
    }
    function confirmChar() {
        const charKey = tempSelectedCharKey;
        const charName = CHAR_IMGS[charKey].name;
        document.getElementById(`p${targetPlayerIdForChar}-char-val`).value = charKey;
        const targetSpan = document.getElementById(`p${targetPlayerIdForChar}-char-name`);
        const img = document.createElement('img');
        img.src = CHAR_IMGS[charKey].lobby;
        img.className = "char-thumb-small";
        targetSpan.innerHTML = "";
        targetSpan.appendChild(img);
        targetSpan.append(` ${charName}`);
        targetSpan.style.color = "#e91e63";
        targetSpan.style.fontWeight = "bold";
        closeCharModal();
    }
    function idToBoxId(id) { return `p${id}-box`; }

    function startGame() {
        players = [];
        const ids = [1, 2, 3, 4];
        let validCount = 0;
        ids.forEach(id => {
            const cls = document.getElementById(`p${id}-class`).value;
            const name = document.getElementById(`p${id}-name`).value;
            const charKey = document.getElementById(`p${id}-char-val`).value;
            if (cls && name) {
                players.push({
                    id: id, class: cls, name: name, character: charKey,
                    score: 0, timeLeft: TOTAL_TIME, active: true,
                    consecutiveCorrect: 0, state: 'default'
                });
                validCount++;
            }
        });
        if (validCount < 1) {
            document.getElementById('login-msg').textContent = "ì ì–´ë„ í•œ ëª…ì€ ë°˜ê³¼ ì´ë¦„ì„ ì„ íƒí•´ì•¼ í•´ìš”!";
            return;
        }
        document.getElementById('setup-screen').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        ids.forEach(id => { const box = document.getElementById(idToBoxId(id)); if(box) box.style.display = 'none'; });
        players.forEach(p => { const box = document.getElementById(idToBoxId(p.id)); if(box) { box.style.display = 'flex'; updatePlayerBoxUI(p); } });
        currentPlayerIndex = 0;
        startRound();
    }

    function startRound() {
        const activePlayers = players.filter(p => p.active);
        if (activePlayers.length === 0) { endGame(); return; }
        let loop = 0;
        while (!players[currentPlayerIndex].active) {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            loop++;
            if(loop > players.length) { endGame(); return; }
        }
        const currP = players[currentPlayerIndex];
        moveTurnIndicator(currP.id);
        document.querySelectorAll('.player-box').forEach(b => b.classList.remove('active'));
        const activeBox = document.getElementById(idToBoxId(currP.id));
        if(activeBox) activeBox.classList.add('active');
        
        currP.state = 'default';
        updatePlayerBoxUI(currP);
        
        // ì¿¨íƒ€ì„ í•´ì œ ë° ì…ë ¥ì°½ í™œì„±í™”
        isProcessing = false;
        const inp = document.getElementById('answerInput');
        inp.value = '';
        inp.classList.remove('disabled');
        document.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('disabled'));
        document.getElementById('feedback').innerHTML = '';

        generateProblem();
        problemStartTime = Date.now();
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (currP.timeLeft > 0) {
                currP.timeLeft--;
                updatePlayerBoxUI(currP);
            } else {
                currP.active = false;
                currP.state = 'lose';
                const timeOutBox = document.getElementById(idToBoxId(currP.id));
                if(timeOutBox) timeOutBox.classList.add('timeout');
                updatePlayerBoxUI(currP);
                clearInterval(timerInterval);
                document.getElementById('feedback').textContent = "â° ì‹œê°„ ë!";
                setTimeout(nextTurn, 1500);
            }
        }, 1000);
    }

    function nextTurn() {
        if(players[currentPlayerIndex] && players[currentPlayerIndex].active) {
            players[currentPlayerIndex].state = 'default';
            updatePlayerBoxUI(players[currentPlayerIndex]);
        }
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        startRound();
    }

    function moveTurnIndicator(pid) {
        const ind = document.getElementById('turn-indicator');
        const positions = { 1: { top: '25%', left: '25%' }, 2: { top: '75%', left: '25%' }, 3: { top: '75%', left: '75%' }, 4: { top: '25%', left: '75%' } };
        if(positions[pid]) { ind.style.top = positions[pid].top; ind.style.left = positions[pid].left; }
    }

    // ë¬¸ì œ ìƒì„± (0, 1 íšŒí”¼)
    function generateProblem() {
        const rand = Math.random();
        let n1, n2, op;
        if (rand < 0.4) {
            op = '+'; n1 = Math.floor(Math.random() * 50) + 10; n2 = Math.floor(Math.random() * 8) + 2;   
            if ((n1 % 10) + n2 >= 10) n2 = 9 - (n1 % 10); if(n2 < 2) n2 = 2; 
        } else if (rand < 0.7) {
            op = '-'; n1 = Math.floor(Math.random() * 50) + 10; n2 = Math.floor(Math.random() * 8) + 2;   
            if ((n1 % 10) < n2) n2 = n1 % 10; if(n2 < 2) n2 = 2; if((n1 % 10) < 2) n1 += 5; 
        } else {
            op = Math.random() < 0.5 ? '+' : '-'; n1 = Math.floor(Math.random() * 5 + 1) * 10; n2 = Math.floor(Math.random() * 4 + 1) * 10; 
            if(n1 === 10) n1 = 20; if(n2 === 10) n2 = 20;
            if (op === '-' && n1 <= n2) { const temp=n1; n1=n2; n2=temp; if(n1===n2) n1+=10; }
        }
        currentProblem = { n1, n2, op, ans: (op==='+' ? n1+n2 : n1-n2) };
        document.getElementById('problemDisplay').textContent = `${n1} ${op} ${n2} = ?`;
    }

    function checkAnswer() {
        // â˜… ì¿¨íƒ€ì„ ì²´í¬ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
        if(isProcessing) return;

        const val = document.getElementById('answerInput').value;
        if (val === '') return;
        
        isProcessing = true; // ì ê¸ˆ ì‹œì‘
        clearInterval(timerInterval);
        
        // UI ë¹„í™œì„±í™”
        document.getElementById('answerInput').classList.add('disabled');
        document.querySelectorAll('.num-btn').forEach(btn => btn.classList.add('disabled'));

        const userAns = parseInt(val);
        const currP = players[currentPlayerIndex];
        const fb = document.getElementById('feedback');
        const timeSpent = (Date.now() - problemStartTime) / 1000;
        let scoreAdd = 0;

        if (userAns === currentProblem.ans) {
            scoreAdd = 10;
            let msg = "â­• ì •ë‹µ! (+10)";
            if (timeSpent <= 5) { scoreAdd += 5; msg += " âš¡ë¹ ë¦„(+5)"; }
            if (currP.consecutiveCorrect >= 2) { scoreAdd += 5; msg += " ğŸ”¥ì—°ì†(+5)"; }
            
            currP.score += scoreAdd;
            currP.consecutiveCorrect++;
            currP.state = 'correct';
            fb.innerHTML = `<span style="color:#2e7d32">${msg}</span>`;
        } else {
            currP.consecutiveCorrect = 0;
            currP.state = 'wrong';
            fb.innerHTML = `<span style="color:#c62828; font-size:0.9em;">ì•„ê¹Œì›Œìš”! ì •ë‹µì€ ${currentProblem.ans}! ë‹´ì—” í•  ìˆ˜ ìˆì–´!</span>`;
        }
        updatePlayerBoxUI(currP);
        setTimeout(nextTurn, 2000); // 2ì´ˆ í›„ ë‹¤ìŒ í„´
    }

    function updatePlayerBoxUI(p) {
        const box = document.getElementById(idToBoxId(p.id));
        if (!box) return;
        const min = Math.floor(p.timeLeft / 60);
        const sec = String(p.timeLeft % 60).padStart(2, '0');
        let imgState = p.state; if (!p.active) imgState = 'lose';
        const img = CHAR_IMGS[p.character][imgState] || CHAR_IMGS[p.character]['default'];
        box.innerHTML = `<div class="p-info"><span>${p.class}ë°˜</span><span>${min}:${sec}</span></div><div class="p-char-img"><img src="${img}"></div><div style="text-align:center;"><div class="p-name">${p.name}</div><div style="font-weight:bold; color:#ff7043;">${p.score} êµ¬ìŠ¬</div></div>`;
    }

    function pressKey(k) {
        // ì¿¨íƒ€ì„ ì¤‘ ì…ë ¥ ì°¨ë‹¨
        if(isProcessing) return;
        const inp = document.getElementById('answerInput'); 
        if (k === 'C') inp.value = ''; 
        else if (inp.value.length < 3) inp.value += k; 
    }
    
    document.addEventListener('keydown', (e) => { 
        if (!document.getElementById('game-screen').classList.contains('active')) return; 
        if(isProcessing) return; // í‚¤ë³´ë“œ ì…ë ¥ë„ ì°¨ë‹¨

        if (e.key >= '0' && e.key <= '9') pressKey(e.key); 
        else if (e.key === 'Backspace') { const el=document.getElementById('answerInput'); el.value=el.value.slice(0,-1); } 
        else if (e.key === 'Enter') checkAnswer(); 
    });
    
    function restartGame() { location.reload(); }

    async function endGame() {
        document.getElementById('game-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        players.forEach(p => { p.state = p.score > 0 ? 'win' : 'lose'; });
        for (const p of players) {
            if (p.score > 0) {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ className: p.class, name: p.name, score: p.score })
                });
            }
        }
        const res = await fetch(SCRIPT_URL + "?action=getRank");
        const rankData = await res.json();
        drawChart(rankData, players);
    }

    function drawChart(serverScores, currentPlayers) {
        const container = document.getElementById('chart-area');
        container.innerHTML = '';
        const myContrib = { 1:0, 2:0, 3:0, 4:0 };
        currentPlayers.forEach(p => { if (p.score > 0) myContrib[p.class] += p.score; });
        const baseScores = serverScores;
        let maxScore = 0;
        for(let i=1; i<=4; i++) { const total = (baseScores[i] || 0) + myContrib[i]; if(total > maxScore) maxScore = total; }
        maxScore = Math.max(maxScore, 1000);
        for (let i = 1; i <= 4; i++) {
            const currentTotal = (baseScores[i] || 0);
            const heightPercent = (currentTotal / maxScore) * 85; 
            const group = document.createElement('div');
            group.className = 'chart-bar-group';
            const bar = document.createElement('div');
            bar.className = `bar class-${i}`;
            bar.style.height = '0%'; 
            const scoreLabel = document.createElement('div');
            scoreLabel.className = 'score-label';
            scoreLabel.textContent = currentTotal; 
            if (myContrib[i] > 0) {
                const myPart = document.createElement('div');
                myPart.className = 'my-contribution';
                myPart.style.height = '0%';
                setTimeout(() => {
                    const addedTotal = currentTotal + myContrib[i];
                    const addedHeight = (addedTotal / maxScore) * 85;
                    bar.style.height = addedHeight + '%';
                    scoreLabel.textContent = addedTotal;
                    scoreLabel.style.color = '#e91e63';
                    scoreLabel.style.transform = 'scale(1.2)';
                }, 1000);
                bar.appendChild(myPart);
            }
            bar.appendChild(scoreLabel);
            group.appendChild(bar);
            const label = document.createElement('div');
            label.className = 'class-label';
            label.textContent = `${i}ë°˜`;
            group.appendChild(label);
            container.appendChild(group);
            setTimeout(() => { bar.style.height = heightPercent + '%'; }, 100);
        }
    }
</script>
</body>
</html>
